(()=>{"use strict";class e{constructor({link:e,title:t,owner:s,thisUser:r,likes:i,cardId:o,cardSelector:n,handleCardClick:l,handleLikeClick:a,handleDelBtnClick:c}){this._cardSelector=n,this._image=e,this._title=t,this._owner=s,this._thisUser=r,this._likes=i,this.cardId=o,this._cardTemplate=document.querySelector(this._cardSelector),this._handleCardClick=l,this._handleLikeClick=a,this._handleDelBtnClick=c,this._delClick=this._delClick.bind(this),this._revertHeart=this._revertHeart.bind(this)}_getTemplate(){return this._cardTemplate.content.querySelector(".picture-card").cloneNode(!0)}_revertHeart(e){const t=this._elementLike.classList.contains("picture-card__like_active");this._elementLike.classList.toggle("picture-card__like_active"),this._elementLikeCounter.textContent=this._likes.length+(t?-1:1),this._handleLikeClick(this.cardId,t,this)}_delClick(e){this._handleDelBtnClick(this)}deleteCard(){this._element.remove(),this._element=null}likesUpdate(e){this._likes=e,this._checkLikes()}_checkLikes(){this._elementLikeCounter.textContent=this._likes.length,-1!==this._likes.findIndex((e=>e._id==this._thisUser))&&this._elementLike.classList.add("picture-card__like_active")}_setEventListeners(){this._elementLike.addEventListener("click",this._revertHeart),this._elementDelBtn.addEventListener("click",this._delClick),this._picture.addEventListener("click",this._handleCardClick)}generateCard(){return this._element=this._getTemplate(),this._picture=this._element.querySelector(".picture-card__picture"),this._picture.src=this._image,this._picture.alt=this._title,this._element.querySelector(".picture-card__title").textContent=this._title,this._elementLike=this._element.querySelector(".picture-card__like"),this._elementLikeCounter=this._element.querySelector(".picture-card__like-counter"),this._elementDelBtn=this._element.querySelector(".picture-card__delButton"),this._owner!==this._thisUser&&this._element.querySelector(".picture-card__delButton").classList.add("picture-card__delButton_disable"),this._checkLikes(),this._setEventListeners(),this._element}}class t{constructor(e){this._popupSelector=e,this._popupElement=document.querySelector(this._popupSelector),this._handleEscClose=this._handleEscClose.bind(this),this._handleOutsideClose=this._handleOutsideClose.bind(this),this._handleCLosePopupButton=this._handleCLosePopupButton.bind(this)}open(){this._popupElement.classList.add("popup_opened"),this.setEventListeners()}close(){this._popupElement.classList.remove("popup_opened"),this._popupElement.querySelector(".popup__close-button").removeEventListener("click",this._handleCLosePopupButton),this._popupElement.removeEventListener("click",this._handleOutsideClose),document.removeEventListener("keydown",this._handleEscClose)}_handleEscClose(e){"Escape"===e.key&&this.close()}_handleOutsideClose(e){e.target.classList.contains("popup")&&this.close()}_handleCLosePopupButton(){this.close()}setEventListeners(){this._popupElement.querySelector(".popup__close-button").addEventListener("click",this._handleCLosePopupButton),this._popupElement.addEventListener("click",this._handleOutsideClose),document.addEventListener("keydown",this._handleEscClose)}}class s extends t{constructor({popupSelector:e,submitFormHandler:t}){super(e),this._popupElement=document.querySelector(this._popupSelector),this._submitFormHandler=t,this._form=this._popupElement.querySelector(".popup__form"),this._submitBtn=this._popupElement.querySelector(".popup__submit-button"),this._submitButtonClick=this._submitButtonClick.bind(this),this._inputList=this._form.querySelectorAll(".popup__input")}close(){super.close(),this._form.reset(),this._form.removeEventListener("submit",this._submitButtonClick)}_getInputValues(){return this._formValues={},this._inputList.forEach((e=>this._formValues[e.name]=e.value)),this._formValues}_submitButtonClick(e){e.preventDefault(),this._submitFormHandler(this._getInputValues()),this.close()}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",this._submitButtonClick)}setButtonText(e){this._submitBtn.textContent=e}getButtonText(){return this._submitBtn.textContent}}class r{constructor(e,t){this._config=e,this._selector=t}_showInputError(e){this._selector.querySelector(`#${e.id}-error`).textContent=e.validationMessage,e.classList.add(this._config.inputErrorClass)}_hideInputError(e){this._selector.querySelector(`#${e.id}-error`).textContent="",e.classList.remove(this._config.inputErrorClass)}_checkInputValidity(e){e.validity.valid?this._hideInputError(e):this._showInputError(e)}_setButtonState(e){e?(this._submitButton.classList.remove(this._config.inactiveButtonClass),this._submitButton.disabled=!1):(this._submitButton.classList.add(this._config.inactiveButtonClass),this._submitButton.disabled=!0)}_setEventListeners(){this._inputList=this._selector.querySelectorAll(this._config.inputSelector),this._submitButton=this._selector.querySelector(this._config.submitButtonSelector),this._inputList.forEach((e=>{e.addEventListener("input",(()=>{this._checkInputValidity(e),this._setButtonState(this._selector.checkValidity())}))}))}_checkValidation(e,t){Array.from(e.querySelectorAll(t.inputSelector)).forEach((e=>{this._hideInputError(e)}))}clearFormErrors(){this._checkValidation(this._selector,this._config)}enableValidation(){this._setEventListeners(),this._selector.addEventListener("submit",(e=>{e.preventDefault(),this._setButtonState(!1)})),this._setButtonState(this._selector.checkValidity())}}const i=document.querySelector(".user-info__edit-button"),o=document.querySelector(".add-picture-button"),n=document.querySelector(".popup_edit-user-profile"),l=n.querySelector(".popup__form"),a=document.querySelector(".popup_add-card").querySelector(".popup__form"),c=n.querySelector(".popup__input_type_name"),u=n.querySelector(".popup__input_type_profession"),h=document.querySelector(".popup_edit-avatar").querySelector(".popup__form"),_=document.querySelector(".user-info__edit-avatar");let p;const d=new class{constructor(e){this._headers=e.headers,this._baseUrl=e.baseUrl,this._cardsUrl=e.cardsUrl}_getResponseData(e){return e.ok?e.json():Promise.reject(`Хьюстон у нас: ${e.status}`)}getInitialCards(){return fetch(this._baseUrl+this._cardsUrl,{headers:this._headers}).then((e=>this._getResponseData(e)))}getUserInfo(){return fetch(this._baseUrl+"users/me",{headers:this._headers}).then((e=>this._getResponseData(e)))}setUserInfo(e){return fetch(this._baseUrl+"users/me",{headers:this._headers,method:"PATCH",body:JSON.stringify({name:e.name,about:e.about})}).then((e=>this._getResponseData(e)))}setUserAvatar(e){return fetch(this._baseUrl+"users/me/avatar",{headers:this._headers,method:"PATCH",body:JSON.stringify({avatar:e.link})}).then((e=>this._getResponseData(e)))}setNewCard(e){return fetch(this._baseUrl+"cards",{headers:this._headers,method:"POST",body:JSON.stringify({name:e.name,link:e.link})}).then((e=>this._getResponseData(e)))}delCard(e){return fetch(this._baseUrl+"cards/"+e.cardId,{headers:this._headers,method:"DELETE"}).then((e=>this._getResponseData(e)))}reverseLike(e,t){return fetch(this._baseUrl+"cards/likes/"+e,{headers:this._headers,method:t?"DELETE":"PUT"}).then((e=>this._getResponseData(e)))}}({baseUrl:"https://mesto.nomoreparties.co/v1/cohort-19/",headers:{authorization:"e3cff522-5db4-4e70-ac70-f1e7cecd8c6e","Content-Type":"application/json"},cardsUrl:"cards"}),m={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__submit-button",inactiveButtonClass:"popup__submit-button_state_disActive",inputErrorClass:"popup__input_state_invalid",errorClass:"popup__input-error"},f=new r(m,l);f.enableValidation();const k=new r(m,a);k.enableValidation();const C=new r(m,h);C.enableValidation();const E=new class extends t{constructor(e,t){super(e,t),this._placeElement=this._popupElement.querySelector(".popup__title"),this._pictureElement=this._popupElement.querySelector(".popup__picture")}open(e,t){super.open(),this._placeElement.textContent=e,this._pictureElement.src=t,this._pictureElement.alt=e}}(".popup_show-image");function S(t){return new e({cardSelector:".picture-card-template",link:t.link,title:t.name,owner:t.owner._id,thisUser:p,likes:t.likes,cardId:t._id,handleCardClick:()=>{E.open(t.name,t.link)},handleLikeClick:(e,t,s)=>{d.reverseLike(e,t).then((e=>{s.likesUpdate(e.likes)})).catch((e=>{console.log(e)}))},handleDelBtnClick:e=>{g.cardObject=e,g.open()}}).generateCard()}const b=new class{constructor({renderer:e},t){this._renderer=e,this._container=document.querySelector(t)}renderItems(e){e.forEach((e=>{this._renderer(e)}))}addItem(e,t=!0){t?this._container.append(e):this._container.prepend(e)}}({renderer:e=>{const t=S(e);b.addItem(t,!0)}},".pictures-grid"),v=new class{constructor(e){this._nameSelector=e.nameSelector,this._footerNameSelector=e.footerNameSelector,this._profSelector=e.profSelector,this._avatarSelector=e.avatarSelector,this._userNameElement=document.querySelector(this._nameSelector),this._userProfElement=document.querySelector(this._profSelector),this._userAvatarElement=document.querySelector(this._avatarSelector),this._userFooterNameElement=document.querySelector(this._footerNameSelector)}getUserInfo(){return this._userCurrentValue=this._userNameElement.textContent,this._userProfCurrentValue=this._userProfElement.textContent,this._formProfileValues={},this._formProfileValues.name=this._userCurrentValue,this._formProfileValues.about=this._userProfCurrentValue,this._formProfileValues}setUserInfo(e){this._userNameElement.textContent=e.name,this._userProfElement.textContent=e.about,this._userFooterNameElement.textContent=e.name}setUserAvatar(e,t){this._userAvatarElement.src=e,this._userAvatarElement.alt=t}}({nameSelector:".user-info__name",profSelector:".user-info__profession",avatarSelector:".user-info__picture",footerNameSelector:".footer__name"}),L=new s({popupSelector:".popup_edit-user-profile",submitFormHandler:e=>{const t=L.getButtonText();L.setButtonText("Сохранение.."),d.setUserInfo(e).then((e=>{v.setUserInfo({name:e.name,about:e.about}),L.close()})).catch((e=>{console.log(e)})).finally((()=>{L.setButtonText(t)}))}}),y=new s({popupSelector:".popup_edit-avatar",submitFormHandler:e=>{const t=y.getButtonText();y.setButtonText("Сохранение.."),d.setUserAvatar(e).then((e=>{v.setUserAvatar(e.avatar,e.name),y.close()})).catch((e=>{console.log(e)})).finally((()=>{y.setButtonText(t)}))}}),g=new s({popupSelector:".popup_del-confirm",submitFormHandler:e=>{const t=g.getButtonText();g.setButtonText("Удаление.."),d.delCard(g.cardObject).then((e=>{g.cardObject.deleteCard(),g.close(),g.cardObject=""})).catch((e=>{console.log(e)})).finally((()=>{g.setButtonText(t)}))}});Promise.all([d.getUserInfo(),d.getInitialCards()]).then((e=>{p=e[0]._id,v.setUserInfo({name:e[0].name,about:e[0].about}),v.setUserAvatar(e[0].avatar,e[0].name),b.renderItems(e[1])})).catch((e=>{console.log(e)}));const B=new s({popupSelector:".popup_add-card",submitFormHandler:e=>{const t=B.getButtonText();B.setButtonText("Сохранение.."),d.setNewCard(e).then((e=>{const t=S(e);b.addItem(t,!1),B.close()})).catch((e=>{console.log(e)})).finally((()=>{B.setButtonText(t)}))}});i.addEventListener("click",(()=>{var e;e=v.getUserInfo(),c.value=e.name,u.value=e.about,L.open(),f.clearFormErrors()})),_.addEventListener("click",(()=>{y.open(),C.clearFormErrors()})),o.addEventListener("click",(()=>{k.clearFormErrors(),B.open()}))})();